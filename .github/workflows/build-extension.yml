name: Build - Extension

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "webview/**"
      - "resources/icons/**"
      - "scripts/build-icons.js"
      - "package.json"
      - "webpack.config.js"
      - ".github/workflows/build-extension.yml"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "webview/**"
      - "resources/icons/**"
      - "scripts/build-icons.js"
      - "package.json"
      - "webpack.config.js"
      - ".github/workflows/build-extension.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test Universal VSIX
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required for actions/checkout

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          set +e  # Don't exit on error so we can see full output
          npm install --ignore-engines
          NPM_EXIT_CODE=$?
          echo ""
          echo "üìä npm install exit code: $NPM_EXIT_CODE"
          echo ""
          echo "üìÇ Workspace root after install:"
          ls -la
          echo ""
          echo "üì¶ node_modules/@datalayer:"
          ls -la node_modules/@datalayer/ || echo "Directory not found"
          echo ""
          echo "üîç Checking @datalayer/jupyter-lexical structure:"
          if [ -d "node_modules/@datalayer/jupyter-lexical" ]; then
            echo "‚úì Package directory exists"
            PACKAGE_VERSION=$(cat node_modules/@datalayer/jupyter-lexical/package.json | grep '"version"' | head -1)
            echo "  Version: $PACKAGE_VERSION"
            echo ""
            echo "  Top-level contents:"
            ls -la node_modules/@datalayer/jupyter-lexical/ | head -20
            echo ""
            if [ -d "node_modules/@datalayer/jupyter-lexical/lib" ]; then
              echo "  ‚úì lib/ directory exists"
              if [ -d "node_modules/@datalayer/jupyter-lexical/lib/plugins" ]; then
                echo "  ‚úì lib/plugins/ directory exists"
                echo "    Plugin files:"
                ls node_modules/@datalayer/jupyter-lexical/lib/plugins/*.js 2>/dev/null | head -10
              else
                echo "  ‚úó lib/plugins/ directory NOT FOUND"
                echo "    lib/ contents:"
                ls -la node_modules/@datalayer/jupyter-lexical/lib/
              fi
            else
              echo "  ‚úó lib/ directory NOT FOUND"
            fi
          else
            echo "‚úó Package NOT installed"
          fi
          echo ""
          echo "üîç Verifying zeromq binaries (all platforms):"
          if [ -d "node_modules/zeromq/prebuilds" ]; then
            echo "‚úì zeromq prebuilds directory exists"
            echo "  Platform binaries:"
            ls -la node_modules/zeromq/prebuilds/ | head -20
          else
            echo "‚úó zeromq prebuilds directory NOT FOUND"
          fi
          echo ""
          if [ $NPM_EXIT_CODE -ne 0 ]; then
            echo "‚ùå npm install failed with exit code $NPM_EXIT_CODE"
            exit $NPM_EXIT_CODE
          fi
          echo "‚úÖ npm install succeeded"
        shell: bash

      - name: Debug - Show package.json dependencies
        run: |
          echo "üìÑ package.json dependencies:"
          cat package.json | grep -A 50 '"dependencies"' | head -60
        shell: bash

      - name: Build VS Code extension
        run: npm run compile

      - name: Package universal extension
        run: npm run vsix

      - name: Get VSIX filename
        id: vsix-info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VSIX_FILE="datalayer-jupyter-vscode-${VERSION}.vsix"

          if [ -f "$VSIX_FILE" ]; then
            echo "‚úÖ Found VSIX: $VSIX_FILE"
            echo "vsix_filename=$VSIX_FILE" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Error: VSIX file not found"
            ls -la *.vsix
            exit 1
          fi
        shell: bash

      - name: Upload universal VSIX artifact
        uses: actions/upload-artifact@v5
        with:
          name: vsix-universal
          path: "*.vsix"
          retention-days: 30

  post-pr-comment:
    name: Post PR Comment with Artifact
    needs: build-and-test
    if: github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Get artifact download URL
        id: get-artifact
        uses: actions/github-script@v8
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const vsixArtifact = artifacts.data.artifacts.find(a => a.name === 'vsix-universal');
            if (vsixArtifact) {
              const url = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${vsixArtifact.id}`;
              core.setOutput('vsix_url', url);
            } else {
              core.setOutput('vsix_url', '');
            }

      - name: Post PR comment with universal VSIX artifact
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: extension-artifact
          message: |
            ## üì¶ Extension Build Ready (Universal VSIX)!

            **Download the extension** (works on all platforms):

            ### [`Download datalayer-jupyter-vscode.vsix` ‚¨áÔ∏è](${{ steps.get-artifact.outputs.vsix_url }})

            > üí° This universal VSIX includes native binaries for all platforms (macOS Intel, macOS ARM, Windows, Linux) and works everywhere!

            [üì• View artifact in workflow run ‚Üí](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---

            <details>
            <summary>üìñ Installation Instructions</summary>

            ### Method 1: VS Code UI
            1. Download the `.vsix` file from the link above
            2. Open VS Code
            3. Go to Extensions (`Ctrl+Shift+X` / `Cmd+Shift+X`)
            4. Click `...` menu ‚Üí "Install from VSIX..."
            5. Select the downloaded file

            ### Method 2: Command Line
            ```bash
            code --install-extension datalayer-jupyter-vscode-{version}.vsix
            ```

            ### Method 3: Drag & Drop
            1. Download the `.vsix` file
            2. Drag it into the VS Code Extensions sidebar

            </details>

            > ‚úÖ **Universal build**: This extension includes native modules (zeromq) with pre-built binaries for all platforms via `@vscode/zeromq`.
            >
            > Build successful ‚Ä¢ [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  test-installation:
    name: Test Extension Installation
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Download universal extension artifact
        uses: actions/download-artifact@v5
        with:
          name: vsix-universal
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find ./artifacts -name "*.vsix" -type f

      - name: Verify extension package
        run: |
          VSIX_FILE=$(find ./artifacts -name "*.vsix" -type f | head -1)
          if [ -z "$VSIX_FILE" ]; then
            echo "Error: No .vsix file found in artifacts"
            exit 1
          fi

          echo "Found extension package: $VSIX_FILE"
          echo "File size: $(stat -c%s "$VSIX_FILE") bytes"

          # Verify it's a valid zip file (VSIX is a ZIP)
          if ! unzip -t "$VSIX_FILE" > /dev/null 2>&1; then
            echo "Error: Extension package is not a valid ZIP file"
            exit 1
          fi

          echo "‚úÖ Extension package validation successful"

  smoke-tests:
    name: Smoke Tests - ${{ matrix.os }}
    needs: build-and-test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Download extension artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ needs.build-and-test.outputs.artifact-name }}
          path: ./artifacts

      - name: Run smoke tests
        run: bash .github/scripts/run-smoke-tests.sh ./artifacts/*.vsix
        shell: bash

      - name: Report results
        if: failure()
        run: |
          echo "‚ùå Smoke tests failed on ${{ matrix.os }}"
          echo "Check the logs above for details"
        shell: bash
