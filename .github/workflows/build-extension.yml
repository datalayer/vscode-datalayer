name: Build - Extension

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "webview/**"
      - "package.json"
      - "webpack.config.js"
      - ".github/workflows/build-extension.yml"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "webview/**"
      - "package.json"
      - "webpack.config.js"
      - ".github/workflows/build-extension.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    outputs:
      artifact-name: ${{ steps.version-info.outputs.artifact-name }}
    permissions:
      contents: read # Required for actions/checkout
      pull-requests: write # Required to post PR comments
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ["20"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: |
          set +e  # Don't exit on error so we can see full output
          npm install --ignore-engines
          NPM_EXIT_CODE=$?
          echo ""
          echo "ðŸ“Š npm install exit code: $NPM_EXIT_CODE"
          echo ""
          echo "ðŸ“‚ Workspace root after install:"
          ls -la
          echo ""
          echo "ðŸ“¦ node_modules/@datalayer:"
          ls -la node_modules/@datalayer/ || echo "Directory not found"
          echo ""
          echo "ðŸ” Searching for jupyter-lexical:"
          find node_modules -name "*jupyter-lexical*" -type d 2>/dev/null || echo "Not found"
          echo ""
          echo "ðŸ” Searching for jupyter-react:"
          find node_modules -name "*jupyter-react*" -type d 2>/dev/null || echo "Not found"
          echo ""
          if [ $NPM_EXIT_CODE -ne 0 ]; then
            echo "âŒ npm install failed with exit code $NPM_EXIT_CODE"
            exit $NPM_EXIT_CODE
          fi
          echo "âœ… npm install succeeded"
        shell: bash

      - name: Debug - Show package.json dependencies
        run: |
          echo "ðŸ“„ package.json dependencies:"
          cat package.json | grep -A 50 '"dependencies"' | head -60
        shell: bash

      - name: Build VS Code extension
        run: npm run compile

      - name: Package extension (.vsix)
        run: npm run vsix

      - name: List generated artifacts
        run: |
          echo "Generated extension package:"
          ls -la *.vsix || echo "No .vsix files found"
        shell: bash

      - name: Get version info
        if: matrix.os == 'ubuntu-latest'
        id: version-info
        run: |
          COMMIT_HASH_LENGTH=7
          VERSION=$(node -p "require('./package.json').version")
          # For PRs, use the actual PR head SHA, otherwise use the current commit
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMIT_HASH_FULL="${{ github.event.pull_request.head.sha }}"
          else
            COMMIT_HASH_FULL="${{ github.sha }}"
          fi
          COMMIT_HASH="${COMMIT_HASH_FULL:0:$COMMIT_HASH_LENGTH}"
          ARTIFACT_NAME="vscode-datalayer-node${{ matrix.node-version }}-${VERSION}-${COMMIT_HASH}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "commit_hash_full=$COMMIT_HASH_FULL" >> $GITHUB_OUTPUT
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Commit: $COMMIT_HASH (Full: $COMMIT_HASH_FULL)"
          echo "Artifact name: $ARTIFACT_NAME"
        shell: bash

      - name: Upload VS Code extension artifact
        if: matrix.os == 'ubuntu-latest'
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version-info.outputs.artifact-name }}
          path: "*.vsix"
          retention-days: 30

      - name: Post PR comment with artifact
        if: matrix.os == 'ubuntu-latest' && github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          replace: true
          header: extension-artifact
          message: |
            ## ðŸ“¦ Extension Build Ready!

            **Download the extension** (works on all platforms):

            [ðŸ“¥ Download build artifact](${{ steps.upload-artifact.outputs.artifact-url }})

            <sup>The artifact contains the <code>.vsix</code> extension package.</sup>

            ---

            <details>
            <summary>ðŸ“– Installation Instructions</summary>

            ### Method 1: VS Code UI
            1. Download the `.vsix` file above
            2. Open VS Code
            3. Go to Extensions (`Ctrl+Shift+X` / `Cmd+Shift+X`)
            4. Click `...` menu â†’ "Install from VSIX..."
            5. Select the downloaded file

            ### Method 2: Command Line
            ```bash
            code --install-extension datalayer-jupyter-vscode.vsix
            ```

            ### Method 3: Drag & Drop
            1. Download the `.vsix` file
            2. Drag it into the VS Code Extensions sidebar

            </details>

            > **Note**: The `.vsix` artifact works on **Windows, macOS, and Linux**.
            >
            > Built from commit [`${{ steps.version-info.outputs.commit_hash }}`](https://github.com/${{ github.repository }}/commit/${{ steps.version-info.outputs.commit_hash_full }}) â€¢ Version `${{ steps.version-info.outputs.version }}` â€¢ [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  test-installation:
    name: Test Extension Installation
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Download extension artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ needs.build-and-test.outputs.artifact-name }}
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find ./artifacts -name "*.vsix" -type f

      - name: Verify extension package
        run: |
          VSIX_FILE=$(find ./artifacts -name "*.vsix" -type f | head -1)
          if [ -z "$VSIX_FILE" ]; then
            echo "Error: No .vsix file found in artifacts"
            exit 1
          fi

          echo "Found extension package: $VSIX_FILE"
          echo "File size: $(stat -c%s "$VSIX_FILE") bytes"

          # Verify it's a valid zip file (VSIX is a ZIP)
          if ! unzip -t "$VSIX_FILE" > /dev/null 2>&1; then
            echo "Error: Extension package is not a valid ZIP file"
            exit 1
          fi

          echo "âœ… Extension package validation successful"
